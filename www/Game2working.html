<!DOCTYPE html>
<html>
<head>
</head>
<body>
<canvas id="mainStage" width=800 height=480>
	<!-- Preload the images in the canvas -->
	<img id="stars" src="img/stars.jpg" />
	<img id="asteroids" src="img/asteroids2.png" />
	<img id="flame" src="img/flame.png" />
</canvas>
<script type="text/javascript" src="js/easeljs.min.js"></script>
<script>

(function(){
	
	var stage = new createjs.Stage(document.getElementById("mainStage"));
	
	var stars = new createjs.Bitmap(document.getElementById("stars"));
	stage.addChild(stars);
	
	var asteroids = new createjs.Bitmap(document.getElementById("asteroids"));
	stage.addChild(asteroids);
	
	var flame = new createjs.Bitmap(document.getElementById("flame"));
	
	
	var shotcount = 0;
	
	var rightArrow = false;
	var leftArrow = false;
	var upArrow = false;
	var downArrow = false;
	var currentX = 100;
	var currentY = 200;
	var dropArray = new Array();
	var speedArray = new Array();
	
	var data = {
			 framerate: 20,
		     images: ["img/UFO1.png", "img/UFO2.png", "img/UFO3.png", "img/UFO4.png", "img/UFO5.png", "img/UFO6.png", "img/UFO7.png", "img/UFO8.png"],
		     frames: {width:120, height:84, count:8, regX:60, regY:42},
		     animations: {land:[0], idle:{frames:[1,1,1,2,2,3,3,3,2,2,2,2,4,4,4,5,5], speed: 1}, forward:[6], backward:[7]}
		 };
		 var ufo = new createjs.SpriteSheet(data);
		 var aIdle = new createjs.Sprite(ufo, "idle");
		 var aLand = new createjs.Sprite(ufo, "land");
		 var aForward = new createjs.Sprite(ufo, "forward");
		 var aBackward = new createjs.Sprite(ufo, "backward");
	
	var beamData = {
				 framerate: 20,
			     images: ["img/beam1.png", "img/beam2.png", "img/beam3.png", "img/beam4.png"],
			     frames: {width:119, height:200, count:4, regX:60, regY:42},
			     animations: {beam:{frames:[0,0,0,1,1,1,2,2,2,3,3,3,2,2,2,1,1,1,0,0,0], speed: 1}}
			 };
		 
	var beamUp = new createjs.SpriteSheet(beamData);
	var aBeam = new createjs.Sprite(beamUp, "beam");
	var beaming = false;
	
	var aFills = [ "rgba(255,0,0,1)", "rgba(255,255,0,1)", "rgba(0,255,0,1)", "rgba(0,255,255,1)", "rgba(0,0,255,1)", "rgba(0,0,0,1)" ];
	
	
	for(var n = 0; n < 6; n++){
		var randColour = Math.floor(Math.random() * 5);
		var drop = new createjs.Shape();
		drop.graphics.beginFill(aFills[randColour]).drawCircle(0, 0, 10);
		dropArray.push(drop);
	}
	
/*	var drop0 = new createjs.Shape();
	drop0.graphics.beginFill("red").drawCircle(0, 0, 10);
	dropArray.push(drop0);
	var drop1 = new createjs.Shape();
	drop1.graphics.beginFill("yellow").drawCircle(0, 0, 10);
	dropArray.push(drop1);
	var drop2 = new createjs.Shape();
	drop2.graphics.beginFill("blue").drawCircle(0, 0, 10);
	dropArray.push(drop2);
	*/
	
	var randSpeed = function(){
	for(var i = 0; i < dropArray.length; i++){
		var speed = Math.random()*10;
		if(speed < 2) speed = 2;
		speedArray.push(speed);
		console.log("Speed:" + speedArray);
	}
	}
	
/*	for(var n = 0; n < 5; n++){
		var drop = new createjs.Shape();
		drop.graphics.beginFill("red").drawCircle(0, 0, 10);
		
		dropArray.push(drop);
		console.log(dropArray);
	}
/*		drop = "drop" + n;
		dropArray.push(drop);
		console.log(dropArray);
	*/	
	var score = 0;
	var scoreTxt = new createjs.Text("Score: " + score, "30px Arial", "#ff7700");
	scoreTxt.x = 620;
	scoreTxt.y = 20;
	
	stage.addChild(scoreTxt);
	
	var updateScore = function(){
		scoreTxt.text = "Score: " + score;
	}
	
	updateScore();
	randSpeed();
	
	
	stage.addChild(aIdle);
	aIdle.x = 100;
	aIdle.y = 200;
	stage.update();
	
	createjs.Ticker.addEventListener("tick", tick);
	createjs.Ticker.setInterval(25);
	createjs.Ticker.setFPS(20);
	
	
	
	recycleDrop = function(drop){
		
		//drop.x = 10 + Math.random() * (stage.canvas.width - 40);
		drop.x = stage.canvas.width - 10;		
		drop.y = stage.canvas.height * Math.random() - 10;
		
		stage.addChild(drop);
		
	}
	
	for (var n = 0; n < dropArray.length; n++) {
		recycleDrop(dropArray[n]);
	}
	
	
	
/// TICK!!! ///	
	function tick() {
			var oRectBeam = aBeam.getBounds();
			//console.log(oRectBeam);
	
			for (var n = 0; n < dropArray.length; n++) {
				dropArray[n].x -= speedArray[n];
				
				if((dropArray[n].x < aBeam.x + 30) && (dropArray[n].x > aBeam.x - 30) && (dropArray[n].y < aBeam.y + 150) && (dropArray[n].y > aBeam.y + 10)){
					//console.log("this here " + dropArray[n].x);
					console.log("COLLISION DETECTED!!!");
					//speedArray[n] = 0;
					dropArray[n].x = currentX;
					dropArray[n].y -= 3;
					//console.log("dropY: " + dropArray[n].y + " currentY: " + currentY);
					if(dropArray[n].y < (currentY + 10)){
						score += 10;
						console.log("SCORE:" + score);
						dropArray[n].x = -1;
						updateScore();
						randSpeed();
					}
				}
				//dropArray[n].y -= 5;
				//console.log("COLLISION DETECTED AT " + collide.x + collide.y); // the position local to dropArray
				if (dropArray[n].x < 0) {
					recycleDrop(dropArray[n]);
				}
			}

			stars.x -= 1;
			asteroids.x -= 2;

			if (stars.x == -800) {
				stars.x = 0;
			}
			if (asteroids.x == -1600) {
				stage.addChildAt(asteroids,1);
				asteroids.x = 6;
			}

			window.onmousemove = function(evtMouse) {
				evtMouse = evtMouse || window.event; // this is for IE
				var mouseX = evtMouse.clientX;
				var mouseY = evtMouse.clientY;
				//stage.addChild(aForward);
				aIdle.x = mouseX;
				aIdle.y = mouseY;

				//stage.update();
			};

			window.onclick = function(evtClick) {

				var mouseX = evtClick.clientX;
				var mouseY = evtClick.clientY;
				stage.addChild(aLand);
				stage.addChild(aBeam);
				aBeam.x = mouseX;
				aBeam.y = mouseY;
				aLand.x = mouseX;
				aLand.y = mouseY;

			}

			var KEYCODE_RIGHT = 39;
			var KEYCODE_LEFT = 37;
			var KEYCODE_UP = 38;
			var KEYCODE_DOWN = 40;
			var KEYCODE_SPACE = 32;
			var KEYCODE_B = 66;

			aForward.x = currentX;
			aForward.y = currentY;
			aBackward.x = currentX;
			aBackward.y = currentY;

			window.onkeydown = function(e) {
				stage.removeChild(aIdle);
				/*		stage.addChild(aForward);
				 */
				currentX = aIdle.x;
				currentY = aIdle.y;

				// 			switch (e.keyCode){
				// 	        case KEYCODE_RIGHT: // right arrow key
				// 	        	rightArrow = true;
				// 	            break;
				// 	        case KEYCODE_LEFT: // left arrow key
				// 	            leftArrow = true;
				// 	            break;
				// 	        case KEYCODE_UP: // up arrow key
				// 	            upArrow = true;
				// 	            break;
				// 	        case KEYCODE_DOWN: // down arrow key
				// 	            downArrow = true;
				// 	            break;
				// 	        case KEYCODE_SPACE:
				// 	        	stage.addChild(aIdle);
				// 	       		if(shotcount != 0){
				// 	       			console.log("already on screen");
				// 	       		}else{

				// 	       			stage.addChild(flame);
				// 	            	shotcount++;
				// 	            	flame.x = currentX + 40;
				// 	           		flame.y = currentY;

				// 	       		}
				// 	        	console.log("shotcount:" + shotcount);
				// 	        	console.log(flame.id);

				// 	        	break;
				// 	        case KEYCODE_B:

				// 	    		stage.addChild(aLand);
				// 	    		stage.addChild(aBeam);
				// 	    		aBeam.x = currentX;
				// 	    		aBeam.y = currentY;
				// 	    		aLand.x = currentX;
				// 	    		aLand.y = currentY;

				// 	        	break;
				// 			}
				// 		}

				// 	if(rightArrow == true){
				//     	stage.addChild(aForward);
				// 		aForward.x += 10;
				//         currentX = aForward.x;
				//         currentY = aForward.y;
				// 	}
				//     if(leftArrow == true){
				//     	stage.addChild(aBackward);
				//     	aBackward.x -= 10;
				//  	  	currentX = aBackward.x;
				//         currentY = aBackward.y;
				//     }
				//  	if(upArrow == true){
				//     	stage.addChild(aIdle);
				//     	aIdle.y -= 10;
				//     	currentX = aIdle.x;
				// 		currentY = aIdle.y;
				//  	}
				//  	if(downArrow == true){
				//     	stage.addChild(aIdle);
				//     	aIdle.y += 10;
				//     	currentX = aIdle.x;
				// 		currentY = aIdle.y;
				//  	}

				switch (e.keyCode) {
				case KEYCODE_RIGHT: // right arrow key
					stage.addChild(aForward);
					aForward.x += 10;
					//world.regX += 10;
					currentX = aForward.x;
					currentY = aForward.y;

					break;
				case KEYCODE_LEFT: // left arrow key
					//world.regX -= 10;
					stage.addChild(aBackward);
					//aBackward.x = currentX;
					//aBackward.y = currentY;
					aBackward.x -= 10;
					currentX = aBackward.x;
					currentY = aBackward.y;
					/*	aBackward.x = currentX;
						aBackward.y = currentY;
					 */
					break;
				case KEYCODE_UP: // up arrow key
					//world.regX -= 10;
					stage.addChild(aIdle);
					aIdle.y -= 10;
					currentX = aIdle.x;
					currentY = aIdle.y;
					break;
				case KEYCODE_DOWN: // down arrow key
					//world.regX -= 10;
					stage.addChild(aIdle);
					aIdle.y += 10;
					currentX = aIdle.x;
					currentY = aIdle.y;
					break;
				case KEYCODE_SPACE:
					stage.addChild(aIdle);
					if (shotcount != 0) {
						console.log("already on screen");
					} else {

						stage.addChild(flame);
						shotcount++;
						flame.x = currentX + 40;
						flame.y = currentY;

					}
					//console.log("shotcount:" + shotcount);
					//console.log("Flame ID:" + flame.id);

					break;
				case KEYCODE_B:

					stage.addChild(aLand);
					stage.addChild(aBeam);
					aBeam.x = currentX;
					aBeam.y = currentY;
					aLand.x = currentX;
					aLand.y = currentY;
					beaming = true;
					console.log("Beam: " + beaming);
					//console.log("BeamX:" + aBeam.x);
					//console.log("BlueDropX:" + dropArray[2].x);
					break;
				default:
					stage.addChild(aIdle);
					aIdle.x = currentX;
					aIdle.y = currentY;
					break;
				}
			}

			if (flame.x < stage.canvas.width) {
				flame.x += 10;
			} else {
				shotcount = 0;
			}

			if (aForward.x >= (stage.canvas.width - 60))
				aForward.x = stage.canvas.width - 60;
			if (aBackward.x <= 60)
				aBackward.x = 60;
			if (aIdle.y <= 42)
				aIdle.y = 42;
			if (aIdle.y >= (stage.canvas.height - 42))
				aIdle.y = stage.canvas.height - 42;

			window.onkeyup = function(e) {
				stage.removeChild(aForward);
				stage.removeChild(aBackward);
				stage.addChild(aIdle);
				stage.removeChild(aLand);
				stage.removeChild(aBeam);

				aIdle.x = currentX;
				aIdle.y = currentY;
				currentX = aIdle.x;
				currentY = aIdle.y;
				
				if(e.keyCode == KEYCODE_B){
					beaming = false;
					console.log("Beam: " + beaming);
				}

				//console.log("X:" + currentX);
				//console.log("Y:" + currentY);
			}
			// update the stage:
			stage.update();
		}
	})();
</script>
</body>
</html>