<!DOCTYPE html>
<html>
<head>
</head>
<body>
<canvas id="mainStage" width=800 height=480>
	<!-- Preload the images in the canvas -->
	<img id="stars" src="img/stars.jpg" />
	<img id="asteroids" src="img/asteroids2.png" />
	<img id="flame" src="img/flame.png" />
</canvas>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script type="text/javascript" src="js/easeljs.min.js"></script>
<script>

(function(){
	
	var stage = new createjs.Stage(document.getElementById("mainStage"));
	
	var stars = new createjs.Bitmap(document.getElementById("stars"));
	stage.addChild(stars);
	
	var asteroids = new createjs.Bitmap(document.getElementById("asteroids"));
	stage.addChild(asteroids);
	
	var flame = new createjs.Bitmap(document.getElementById("flame"));
	
	var shotcount = 0;
	
	var rightArrow = false;
	var leftArrow = false;
	var upArrow = false;
	var downArrow = false;
	var currentX = 100;
	var currentY = 200;
	var aAbductee = new Array();
	var aEnemy = new Array();
	var speedArray = new Array();
	var nAbductees = 6;
	var nEnemies = 3;
	
	// UFO animations
	var data = {
			 framerate: 20,
		     images: ["img/UFO1.png", "img/UFO2.png", "img/UFO3.png", "img/UFO4.png", "img/UFO5.png", "img/UFO6.png", "img/UFO7.png", "img/UFO8.png"],
		     frames: {width:120, height:84, count:8, regX:60, regY:42},
		     animations: {land:[0], idle:{frames:[1,1,1,2,2,3,3,3,2,2,2,2,4,4,4,5,5], speed: 1}, forward:[6], backward:[7]}
		 };
		 var ufo = new createjs.SpriteSheet(data);
		 var aIdle = new createjs.Sprite(ufo, "idle");
		 var aLand = new createjs.Sprite(ufo, "land");
		 var aForward = new createjs.Sprite(ufo, "forward");
		 var aBackward = new createjs.Sprite(ufo, "backward");
	
	// Beam animations
	var beamData = {
				 framerate: 20,
			     images: ["img/beam1.png", "img/beam2.png", "img/beam3.png", "img/beam4.png"],
			     frames: {width:119, height:200, count:4, regX:60, regY:42},
			     animations: {beam:{frames:[0,0,0,1,1,1,2,2,2,3,3,3,2,2,2,1,1,1,0,0,0], speed: 1}}
			 };
		 
	var beamUp = new createjs.SpriteSheet(beamData);
	var aBeam = new createjs.Sprite(beamUp, "beam");
	var beaming = false;
	
	var aFills = [ "rgba(255,0,0,1)", "rgba(255,255,0,1)", "rgba(0,255,0,1)", "rgba(0,255,255,1)", "rgba(0,0,255,1)", "rgba(0,0,0,1)" ];
	
	// create abductees
	for(var n = 0; n < nAbductees; n++){
		var randColour = Math.floor(Math.random() * 5);
		var drop = new createjs.Shape();
		drop.graphics.beginFill(aFills[randColour]).drawCircle(0, 0, 10);
		aAbductee.push(drop);
	}
	
	// create enemies
	for(var i = 0; i < nEnemies; i++){
		//var randColour = Math.floor(Math.random() * 5);
		
		var enemy = new createjs.Shape();
		enemy.graphics.beginFill("red").drawRect(0, 0, 50, 50);
		enemy["beenHit"] = false;
		console.log(enemy.beenHit);
		aEnemy.push(enemy);
	}
	
/*	var drop0 = new createjs.Shape();
	drop0.graphics.beginFill("red").drawCircle(0, 0, 10);
	aAbductee.push(drop0);
	var drop1 = new createjs.Shape();
	drop1.graphics.beginFill("yellow").drawCircle(0, 0, 10);
	aAbductee.push(drop1);
	var drop2 = new createjs.Shape();
	drop2.graphics.beginFill("blue").drawCircle(0, 0, 10);
	aAbductee.push(drop2);
	*/
	
	var randSpeed = function(){
	for(var i = 0; i < aAbductee.length; i++){
		var speed = Math.random()*10;
		if(speed < 2) speed = 2;
		speedArray.push(speed);
		console.log("Speed:" + speedArray);
	}
	}
	
/*	for(var n = 0; n < 5; n++){
		var drop = new createjs.Shape();
		drop.graphics.beginFill("red").drawCircle(0, 0, 10);
		
		aAbductee.push(drop);
		console.log(aAbductee);
	}
/*		drop = "drop" + n;
		aAbductee.push(drop);
		console.log(aAbductee);
	*/	
	var score = 0;
	var scoreTxt = new createjs.Text("Score: " + score, "30px Arial", "#ff7700");
	scoreTxt.x = 620;
	scoreTxt.y = 20;
	stage.addChild(scoreTxt);
	
	var updateScore = function(){
		scoreTxt.text = "Score: " + score;
	}
	
	updateScore();
	randSpeed();
	
	
	stage.addChild(aIdle);
	aIdle.x = 100;
	aIdle.y = 200;
	stage.update();
	
	var startTick = function(){
		createjs.Ticker.addEventListener("tick", tick);
		createjs.Ticker.setInterval(25);
		createjs.Ticker.setFPS(20);
		//createjs.Ticker.setPaused(false);
	}
	
	var stopTick = function(){
		createjs.Ticker.removeEventListener("tick", tick);
	}
	
	var startGame = function(){
		startTick();
		console.log("now in startGame function");
	}
	
	
	recycleDrop = function(drop){
		
		//drop.x = 10 + Math.random() * (stage.canvas.width - 40);
		drop.x = stage.canvas.width - 10;		
		drop.y = stage.canvas.height * Math.random() - 10;
		
		stage.addChild(drop);
		
	}
	
	for (var n = 0; n < aAbductee.length; n++) {
		recycleDrop(aAbductee[n]);
	}
	
	recycleEnemy = function(enemy){
		
		//drop.x = 10 + Math.random() * (stage.canvas.width - 40);
		enemy.x = stage.canvas.width - 10;		
		enemy.y = stage.canvas.height * Math.random() - 10;
		
		stage.addChild(enemy);
		
	}
	
	for (var n = 0; n < aEnemy.length; n++) {
		recycleDrop(aEnemy[n]);
	}
	
	var KEYCODE_ENTER = 13;
	
	var gameOverTxt = new createjs.Text("GAME OVER", "70px Arial", "#ff7700");
	gameOverTxt.x = 180;
	gameOverTxt.y = 200;
	var restartTxt = new createjs.Text("(ENTER to restart)", "25px Arial", "#ff7700");
	restartTxt.x = 290;
	restartTxt.y = 270;
	
	
	var dead = false;
	
	startGame();
	
/// TICK!!! ///	
	function tick() {
			var oRectBeam = aBeam.getBounds();
			//console.log(oRectBeam);
			if(dead){
			window.onkeydown = function(e) {
					if(e.keyCode == 13){
						window.location.reload();
// 						dead = false;
// 						console.log("you pressed enter");
// 					//createjs.Ticker.on("tick", tick);
// 						score = 0;
				
// 						stage.removeChild(gameOverTxt);
// 						updateScore();
// 						//startTick();
// 						startGame();
					}
				}
			}
			
			var gameOver = function(){
				dead = true;
				//createjs.Ticker.off("tick", tick);
				console.log("GAME OVER");
				console.log("Dead: " + dead);
				
				stage.addChild(gameOverTxt);
				stage.addChild(restartTxt);
				//stopTick();
				
			}
			
			
			
			if(!dead){
			for (var n = 0; n < aAbductee.length; n++) {
				aAbductee[n].x -= speedArray[n];
				
				if((aAbductee[n].x < aBeam.x + 30) && (aAbductee[n].x > aBeam.x - 30) && (aAbductee[n].y < aBeam.y + 150) && (aAbductee[n].y > aBeam.y + 10)){
					//console.log("this here " + aAbductee[n].x);
					console.log("COLLISION DETECTED!!!");
					//speedArray[n] = 0;
					aAbductee[n].x = currentX;
					aAbductee[n].y -= 3;
					//console.log("dropY: " + aAbductee[n].y + " currentY: " + currentY);
					if(aAbductee[n].y < (currentY + 10) && beaming == true){
						score += 10;
						console.log("SCORE:" + score);
						aAbductee[n].x = -1;
						updateScore();
						randSpeed();
					}
				}
				//aAbductee[n].y -= 5;
				//console.log("COLLISION DETECTED AT " + collide.x + collide.y); // the position local to aAbductee
				if (aAbductee[n].x < 0) {
					recycleDrop(aAbductee[n]);
				}
			}

			for(var n = 0; n < aEnemy.length; n++){
				//if (aEnemy[n].regY > (flame.y - 20) && aEnemy[n].regY < (flame.y + 20) && aEnemy[n].regX > (flame.x - 20) && aEnemy[n].regX < (flame.x + 20)){
					//console.log("been hit noooo: " + aEnemy[n].beenHit);
					var pt = flame.localToLocal(0, 0, aEnemy[n]);
					if (aEnemy[n].hitTest(pt.x, pt.y)){
// 						aEnemy[n].alpha = 0.1;
						aEnemy[n].beenHit = true;
						stage.removeChild(flame);
						stage.removeChild(aEnemy[n]);
						console.log("HIT !!!!!!!!!!!!");
						
						console.log("been hit: " + aEnemy[n].beenHit);
						shotcount = 0;
					}
					
				//}
			}
			
			for (var n = 0; n < aEnemy.length; n++) {
				aEnemy[n].x -= speedArray[n];
				var idleCollide = aIdle.localToLocal(0, 0, aEnemy[n]);
				var forwardCollide = aForward.localToLocal(0, 0, aEnemy[n]);
				//if(aEnemy[n].beenHit = false){
					if (aEnemy[n].hitTest(idleCollide.x, idleCollide.y)){
//							aEnemy[n].alpha = 0.1;
						stage.removeChild(aIdle);
						stage.removeChild(aEnemy[n]);
						console.log("You died while idle");
						gameOver();
					}
					if (aEnemy[n].hitTest(forwardCollide.x, forwardCollide.y)){
//						aEnemy[n].alpha = 0.1;
						stage.removeChild(aForward);
						stage.removeChild(aEnemy[n]);
						console.log("You died while moving forward");
						gameOver();
					}
				//}
				if (aEnemy[n].x < 0) {
					recycleDrop(aEnemy[n]);
				}
			}
			
			stars.x -= 1;
			asteroids.x -= 2;

			if (stars.x == -800) {
				stars.x = 0;
			}
			if (asteroids.x == -1600) {
				stage.addChildAt(asteroids,1);
				asteroids.x = 6;
			}

			window.onmousemove = function(evtMouse) {
				evtMouse = evtMouse || window.event; // this is for IE
				var mouseX = evtMouse.clientX;
				var mouseY = evtMouse.clientY;
				//stage.addChild(aForward);
				aIdle.x = mouseX;
				aIdle.y = mouseY;

				//stage.update();
			};

			window.onmousedown = function(evtClick) {

				var mouseX = evtClick.clientX;
				var mouseY = evtClick.clientY;
				stage.addChild(aLand);
				stage.addChild(aBeam);
				aBeam.x = mouseX;
				aBeam.y = mouseY;
				aLand.x = mouseX;
				aLand.y = mouseY;

			}

			var KEYCODE_RIGHT = 39;
			var KEYCODE_LEFT = 37;
			var KEYCODE_UP = 38;
			var KEYCODE_DOWN = 40;
			var KEYCODE_SPACE = 32;
			var KEYCODE_SHIFT = 16;
			

			aForward.x = currentX;
			aForward.y = currentY;
			aBackward.x = currentX;
			aBackward.y = currentY;

			window.onkeydown = function(e) {
				stage.removeChild(aIdle);
				
				currentX = aIdle.x;
				currentY = aIdle.y;

				switch (e.keyCode) {
				case KEYCODE_RIGHT: // right arrow key
					stage.addChild(aForward);
					aForward.x += 10;
					//world.regX += 10;
					currentX = aForward.x;
					currentY = aForward.y;

					break;
				case KEYCODE_LEFT: // left arrow key
					//world.regX -= 10;
					stage.addChild(aBackward);
					//aBackward.x = currentX;
					//aBackward.y = currentY;
					aBackward.x -= 10;
					currentX = aBackward.x;
					currentY = aBackward.y;
					/*	aBackward.x = currentX;
						aBackward.y = currentY;
					 */
					break;
				case KEYCODE_UP: // up arrow key
					//world.regX -= 10;
					stage.addChild(aIdle);
					aIdle.y -= 10;
					currentX = aIdle.x;
					currentY = aIdle.y;
					break;
				case KEYCODE_DOWN: // down arrow key
					//world.regX -= 10;
					stage.addChild(aIdle);
					aIdle.y += 10;
					currentX = aIdle.x;
					currentY = aIdle.y;
					break;
				case KEYCODE_SPACE:
					stage.addChild(aIdle);
					if (shotcount != 0) {
						console.log("already on screen");
					} else {

						stage.addChild(flame);
						shotcount++;
						flame.x = currentX + 40;
						flame.y = currentY;

					}
					//console.log("shotcount:" + shotcount);
					//console.log("Flame ID:" + flame.id);

					break;
				case KEYCODE_SHIFT:

					stage.addChild(aLand);
					stage.addChild(aBeam);
					aBeam.x = currentX;
					aBeam.y = currentY;
					aLand.x = currentX;
					aLand.y = currentY;
					beaming = true;
					console.log("Beam: " + beaming);
					//console.log("BeamX:" + aBeam.x);
					//console.log("BlueDropX:" + aAbductee[2].x);
					break;
				
				default:
					stage.addChild(aIdle);
					aIdle.x = currentX;
					aIdle.y = currentY;
					break;
				}
			}

			

			if (flame.x < stage.canvas.width) {
				flame.x += 10;
			} else {
				shotcount = 0;
			}

			if (aForward.x >= (stage.canvas.width - 60))
				aForward.x = stage.canvas.width - 60;
			if (aBackward.x <= 60)
				aBackward.x = 60;
			if (aIdle.y <= 42)
				aIdle.y = 42;
			if (aIdle.y >= (stage.canvas.height - 42))
				aIdle.y = stage.canvas.height - 42;

			window.onkeyup = function(e) {
				stage.removeChild(aForward);
				stage.removeChild(aBackward);
				stage.addChild(aIdle);
				stage.removeChild(aLand);
				stage.removeChild(aBeam);

				aIdle.x = currentX;
				aIdle.y = currentY;
				currentX = aIdle.x;
				currentY = aIdle.y;
				
				if(e.keyCode == KEYCODE_SHIFT){
					beaming = false;
					console.log("Beam: " + beaming);
				}

				//console.log("X:" + currentX);
				//console.log("Y:" + currentY);
			}
			
			
			
			// update the stage:
			stage.update();
			
// 			}else{
// 				window.onkeydown = function(e) {
// 					if(e.keyCode == KEYCODE_ENTER) {
// 						//dead = false;
// 						startGame();
// 					}
// 				}


	// POTENTIAL RESIZING CODE
// 	window.addEventListener(
// 		    'load',
// 		    function () {
// 		        var canvas = document.getElementsByTagName('canvas')[0];
		 
// 		        fullscreenify(canvas);
// 		    },
// 		    false
// 		);
		 
// 		function fullscreenify(canvas) {
// 		    var style = canvas.getAttribute('style') || '';
		    
// 		    window.addEventListener('resize', function () {resize(canvas);}, false);
		 
// 		    resize(canvas);
		 
// 		    function resize(canvas) {
// 		        var scale = {x: 1, y: 1};
// 		        scale.x = (window.innerWidth - 10) / canvas.width;
// 		        scale.y = (window.innerHeight - 10) / canvas.height;
		        
		        
		        
// 		        if (scale.x < 1 || scale.y < 1) {
// 		            scale = '1, 1';
// 		        } else if (scale.x < scale.y) {
// 		            scale = scale.x + ', ' + scale.x;
// 		        } else {
// 		            scale = scale.y + ', ' + scale.y;
// 		        }
		        
// 		        canvas.setAttribute('style', style + ' ' + '-ms-transform-origin: center top; -webkit-transform-origin: center top; -moz-transform-origin: center top; -o-transform-origin: center top; transform-origin: center top; -ms-transform: scale(' + scale + '); -webkit-transform: scale3d(' + scale + ', 1); -moz-transform: scale(' + scale + '); -o-transform: scale(' + scale + '); transform: scale(' + scale + ');');
// 		    }
// 		}
	

 			}
		}
	})();
</script>
</body>
</html>